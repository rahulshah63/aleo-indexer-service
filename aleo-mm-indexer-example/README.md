# Aleo Indexer Example Project

This repository contains an example project demonstrating how to use the `aleo-indexer` CLI and framework to index data from Aleo smart contracts into a PostgreSQL database and expose it via a GraphQL API.

## Project Structure

- `indexer.config.ts`: Defines the Aleo programs, functions, and mappings to be indexed. This is your primary configuration file.
- `drizzle/`: Contains Drizzle ORM related files.
  - `drizzle/config.ts`: Drizzle Kit configuration.
  - `drizzle/index.ts`: Initializes the Drizzle ORM client.
  - `drizzle/generated/`: **(Auto-generated)** Contains your Drizzle schema (`schema.ts`) and relations (`relations.ts`) based on `indexer.config.ts`. **Do not edit these files manually.**
  - `drizzle/migrations/`: **(Auto-generated)** Contains Drizzle migration files.
- `schema.graphql`: **(Auto-generated)** The GraphQL schema generated from `indexer.config.ts`. **Do not edit this file manually.**
- `.env.example`: An example environment file. Copy this to `.env` and fill in your database connection string and Aleo RPC URL.
- `package.json`: Project dependencies and scripts.

## Getting Started

Follow these steps to set up and run the example indexer:

### 1. Prerequisites

- **Bun**: This project uses [Bun](https://bun.sh/) as the JavaScript runtime and package manager.
- **PostgreSQL Database**: You need an accessible PostgreSQL database.

### 2. Environment Setup

Copy the `.env.example` file to `.env` in the root of this `example` directory:
```bash
cp .env.example .env
```

Open .env and configure your database connection string and Aleo RPC URL:
```env
DATABASE_URL="postgresql://user:password@host:port/database"
ALEO_RPC_URL="http://localhost:3030" # Or your Aleo node RPC URL
```

### 3. Install Dependencies

Ensure you have Bun installed. Then, install the project dependencies:
```bash
bun install
```
Note: You will also need to ensure the aleo-indexer package is linked or installed if you're developing it locally. If you're using this as a standalone example, you'd typically publish/install aleo-indexer as a package.

### 4. Generate Schemas

Before you can migrate your database, you need to generate the Drizzle ORM and GraphQL schemas based on your `indexer.config.ts`.

```Bash
bun run generate-schemas
```
This command will create/update:

- `drizzle/generated/schema.ts`
- `drizzle/generated/relations.ts`
- `schema.graphql`

### 5. Run Database Migrations

First, generate a new migration file (if there are schema changes):

```Bash
bun run db:generate-migration
```
Then, apply the pending migrations to your database:

```Bash
bun run db:migrate
```

### 6. Start the Indexer and GraphQL Server

In development mode (with hot-reloading):

```Bash
bun run dev
```
In production mode:

```Bash
bun run start
```

Once the server starts, the GraphQL API will be available at http://localhost:4000/graphql (or your configured port). You can access the GraphiQL IDE in your browser to explore the available queries and data.

## Configuration
The `indexer.config.ts` file is where you define what data you want to index.

- `rpcUrl`: The Aleo RPC endpoint your indexer will connect to.
- `programs`: An array of objects, each defining an Aleo program to index.
  - `programId`: The full Aleo program ID (e.g., `token_registry.aleo`).
  - `functions`: An array of objects, each defining a function within the program to index.
    - `name`: The name of the Aleo function.
    - `tableName`: The desired name for the PostgreSQL table that will store events from this function.
    - `inputs`: An array defining the function's inputs, specifying their Aleo type and (optional) `rpcPath` to extract them from the raw transaction.
    - `extract`: An optional object mapping desired database column names to RPC paths within the raw transaction.
  - `mappings`: An array of objects, each defining a mapping within the program to index.
    - `name`: The name of the Aleo mapping.
    - `tableName`: The desired name for the PostgreSQL table that will store the state of this mapping.
    - `key`: Defines the mapping's key, including its Aleo type and (optional) `rpcPath`.
    - `value`: Defines the mapping's value, including its Aleo type (can be a primitive or a custom struct).
    - `structName`: (Only for `value.kind: 'struct'`) The name of the custom struct, which will be used to generate a corresponding GraphQL type.
    - `fields`: (Only for `value.kind: 'struct'`) Defines the fields within the custom struct.

## GraphQL API
The generated GraphQL schema (schema.graphql) provides queries to fetch your indexed data. You can explore it using the GraphiQL IDE at http://localhost:4000/graphql.

Example Queries:

```GraphQL
query GetRecentTransactions {
  transactions(limit: 10, offset: 0) {
    id
    programId
    functionName
    blockHeight
    timestamp
  }
}

query GetTokenRegistrations {
  tokenRegistrations(limit: 5) {
    id
    transactionId
    tokenId
    tokenSymbol
    decimals
    supplyPublic
    callerAddress
  }
}

query GetTokenMetadata(token_id: "YOUR_TOKEN_ID_FIELD_VALUE") {
  tokenDatum(key: $token_id) {
    key
    value {
      symbol
      decimals
      totalSupply
      owner
    }
    lastUpdatedBlock
  }
}
```

## Contributing
Feel free to open issues or pull requests if you have suggestions or find bugs.